{"changed":true,"filter":false,"title":"main.tf","tooltip":"/clo835-assignment2/terraform_code/dev/instances/main.tf","value":"\n\n#----------------------------------------------------------\n# ACS730 - Week 3 - Terraform Introduction\n#\n# Build EC2 Instances\n#\n#----------------------------------------------------------\n\n#  Define the provider\nprovider \"aws\" {\n  region = \"us-east-1\"\n}\n\n# Data source for AMI id\ndata \"aws_ami\" \"latest_amazon_linux\" {\n  owners      = [\"amazon\"]\n  most_recent = true\n  filter {\n    name   = \"name\"\n    values = [\"amzn2-ami-hvm-*-x86_64-gp2\"]\n  }\n}\n\n\n# Data source for availability zones in us-east-1\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\n# Data block to retrieve the default VPC id\ndata \"aws_vpc\" \"default\" {\n  default = true\n}\n\n# Define tags locally\nlocals {\n  default_tags = merge(module.globalvars.default_tags, { \"env\" = var.env })\n  prefix       = module.globalvars.prefix\n  name_prefix  = \"${local.prefix}-${var.env}\"\n}\n\n# Retrieve global variables from the Terraform module\nmodule \"globalvars\" {\n  source = \"../../modules/globalvars\"\n}\n\n# Reference subnet provisioned by 01-Networking \nresource \"aws_instance\" \"my_amazon\" {\n  ami                         = data.aws_ami.latest_amazon_linux.id\n  instance_type               = lookup(var.instance_type, var.env)\n  key_name                    = aws_key_pair.my_key.key_name\n  vpc_security_group_ids             = [aws_security_group.my_sg.id]\n  associate_public_ip_address = false\n\n  lifecycle {\n    create_before_destroy = true\n  }\n\n  tags = merge(local.default_tags,\n    {\n      \"Name\" = \"${local.name_prefix}-Amazon-Linux\"\n    }\n  )\n}\n\n\n# Adding SSH key to Amazon EC2\nresource \"aws_key_pair\" \"my_key\" {\n  key_name   = local.name_prefix\n  public_key = file(\"${local.name_prefix}.pub\")\n}\n\n# Security Group\nresource \"aws_security_group\" \"my_sg\" {\n  name        = \"allow_ssh\"\n  description = \"Allow SSH inbound traffic\"\n  vpc_id      = data.aws_vpc.default.id\n\n  ingress {\n    description      = \"SSH from everywhere\"\n    from_port        = 22\n    to_port          = 22\n    protocol         = \"tcp\"\n    cidr_blocks      = [\"0.0.0.0/0\"]\n    ipv6_cidr_blocks = [\"::/0\"]\n  }\n\n  egress {\n    from_port        = 0\n    to_port          = 0\n    protocol         = \"-1\"\n    cidr_blocks      = [\"0.0.0.0/0\"]\n    ipv6_cidr_blocks = [\"::/0\"]\n  }\n\n  tags = merge(local.default_tags,\n    {\n      \"Name\" = \"${local.name_prefix}-sg\"\n    }\n  )\n}\n\n# Elastic IP\nresource \"aws_eip\" \"static_eip\" {\n  instance = aws_instance.my_amazon.id\n  tags = merge(local.default_tags,\n    {\n      \"Name\" = \"${local.name_prefix}-eip\"\n    }\n  )\n}\n\n# ECR repository\nresource \"aws_ecr_repository\" \"repo\" {\n  name                 = \"app-repo\"\n  image_tag_mutability = \"MUTABLE\"\n\n}\n\nresource \"aws_ecr_repository\" \"repo\" {\n  name                 = \"db-repo\"\n  image_tag_mutability = \"MUTABLE\"\n\n}\n","undoManager":{"mark":-2,"position":4,"stack":[[{"start":{"row":115,"column":26},"end":{"row":115,"column":37},"action":"remove","lines":["assignment1"],"id":2},{"start":{"row":115,"column":26},"end":{"row":115,"column":27},"action":"insert","lines":["a"]},{"start":{"row":115,"column":27},"end":{"row":115,"column":28},"action":"insert","lines":["p"]},{"start":{"row":115,"column":28},"end":{"row":115,"column":29},"action":"insert","lines":["p"]}],[{"start":{"row":119,"column":0},"end":{"row":120,"column":0},"action":"insert","lines":["",""],"id":3}],[{"start":{"row":120,"column":0},"end":{"row":125,"column":0},"action":"insert","lines":["resource \"aws_ecr_repository\" \"repo\" {","  name                 = \"app-repo\"","  image_tag_mutability = \"MUTABLE\"","","}",""],"id":4}],[{"start":{"row":121,"column":28},"end":{"row":121,"column":29},"action":"remove","lines":["p"],"id":5},{"start":{"row":121,"column":27},"end":{"row":121,"column":28},"action":"remove","lines":["p"]},{"start":{"row":121,"column":26},"end":{"row":121,"column":27},"action":"remove","lines":["a"]}],[{"start":{"row":121,"column":26},"end":{"row":121,"column":27},"action":"insert","lines":["d"],"id":6},{"start":{"row":121,"column":27},"end":{"row":121,"column":28},"action":"insert","lines":["b"]}]]},"ace":{"folds":[],"scrolltop":1401,"scrollleft":0,"selection":{"start":{"row":124,"column":1},"end":{"row":124,"column":1},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":99,"state":"start","mode":"ace/mode/terraform"}},"timestamp":1665453179474}